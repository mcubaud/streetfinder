<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Street Finder Reverse Game</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #mapid { height: 600px; }
        .clignoter_vert {
            animation: clignoter_vert 500ms linear;
        }
        .secouer_petit_orange {
            animation: secouer_petit_orange 1s linear;
        }
        .secouer_petit {
            animation: secouer_petit 1s linear;
        }
        @keyframes clignoter_vert {
            0% { background-color: white; }
            50% { background-color: green; }
            100% { background-color: white; }
        }
        @keyframes secouer_petit_orange {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        @keyframes secouer_petit {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="titre"><h1>Street Finder Game in </h1></div>
    <div id="mapid"></div>

    <p id="score"></p>
    <p id="target_street"></p>
    <p id="remaining_attempts">3 remaining attempts</p>
    <ul id="list_found"></ul>
    <input type="file" id="upload">
    <button id="save">Save Progress</button>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var lieu = localStorage.getItem("lieu");

        if( lieu === null){
            lieu = "Rennes";
        }

        console.log(lieu);
        ///Changer le nom de la page
        document.getElementById("titre").children[0].innerHTML += lieu;
        document.title += " " + lieu;
        ///affichage de la carte
        var mymap;
        if(lieu == "Lyon"){
            mymap = L.map('mapid').setView([45.75728373443727, 4.849433898925782], 13);
        }
        if(lieu == "Rennes"){
            mymap = L.map('mapid').setView([48.11105621460431, -1.676739113603782], 13);
        }

        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(mymap);

        var json_balades = {};

        var promise0 = new Promise((resolve, reject) => {
            var geojson = (lieu == "Lyon") ? "rues.geojson" : "rues_rennes.geojson";
            fetch(geojson)
            .then(r => r.json())
            .then(r => {
                json_balades = r;
                resolve(r);
            });
        });

        var promise = promise0;
        var total_length = 0;
        var find_length = 0;
        var polylines = {};
        var names = {};
        var trouves = {};
        var trouves_uniques = [];
        var currentStreetIndex = 0;
        var attemptsLeft = 3;

        promise
        .then(r => {
            var array = r.features;
            array.sort((a, b) => b.properties.length - a.properties.length);
            for(var i = 0; i < array.length; i++){
                var obj = array[i];
                var lnglats = obj.geometry.coordinates;
                var latlngs = lnglats.map(x => [x[1], x[0]]);

                try{
                    var polyline = L.polyline(latlngs, {color: '#3b364b'}).addTo(mymap);
                    polyline.nom = obj.properties.name;
                    polyline.i = i;
                    var other_tags = obj.properties.other_tags;
                    if (other_tags && other_tags.includes("\"wikipedia\"=>\"")){
                        try{
                            polyline.wiki = other_tags.split("\"wikipedia\"=>\"")[1].split("\"")[0];
                            console.log(polyline.wiki);
                        }finally{}
                    }
                    polyline.length = obj.properties.length;
                    total_length += polyline.length;
                    polyline._path.nom = polyline.nom;
                    polyline._path.i = i;
                    polyline._path.onclick=check_clicked_street;
                    polylines[i] = polyline;
                    names[i] = obj.properties.name;
                    trouves[i] = false;
                }finally{}
            }
            askNextStreet();
        });

        function print_score(){
            document.getElementById("score").innerHTML = Math.round(find_length/1000) + " / " + Math.round(total_length/1000) + " km (" + Math.round(100*find_length/total_length) + "%) des rues trouvées";
            document.getElementById("score").style["color"] = couleur_par_score(find_length/total_length);
        }



        function chercher(){
            var adresse = $("#inputAdresse").val();
            console.log(adresse);
            if(adresse != ""){
                var found = false;
                var alreadyFound = false;
                var last_already;
                for(let i in polylines){
                    var name2 = names[i];
                    if(are_similar(adresse, name2)){
                        if(trouves[i]){
                            alreadyFound = true;
                            last_already = polylines[i];
                        }
                        else{
                            if (i == currentStreetIndex) {
                                polylines[i].setStyle({"color":"green"});
                                polylines[i].bindTooltip(name2);
                                if(polylines[i].wiki){
                                    var [langue, page] = polylines[i].wiki.split(":");
                                    polylines[i].bindPopup(
                                        "<iframe style='height:400px;' src='https://" + langue + ".m.wikipedia.org/wiki/" + page + "'></iframe>"
                                    );
                                }
                                found = true;
                                find_length += polylines[i].length;
                                trouves[i] = true;
                                if (!trouves_uniques.includes(name2)){
                                    add_in_list_found(name2, polylines[i]);
                                }
                                break;
                            }
                        }
                    }
                }
                if(found){
                    document.getElementById("inputAdresse").value = "";
                    print_score();
                    inputAdresse.classList.add("clignoter_vert");
                    setTimeout(() => { inputAdresse.classList.remove("clignoter_vert"); }, 1000);
                    askNextStreet();
                } else if(alreadyFound){
                    last_already.openPopup();
                    mymap.flyToBounds(last_already.getBounds());
                    inputAdresse.classList.add("secouer_petit_orange");
                    setTimeout(() => { inputAdresse.classList.remove("secouer_petit_orange"); }, 1000);
                } else {
                    inputAdresse.classList.add("secouer_petit");
                    setTimeout(() => { inputAdresse.classList.remove("secouer_petit"); }, 1000);
                    attemptsLeft--;
                    if (attemptsLeft <= 0) {
                        alert("You lost! No more attempts left.");
                        // Optionally, you can reset the game here
                        resetGame();
                    }
                }
            }
        }

        function standardize(str){
            str = str.toLowerCase().replace(/-/g, " ").replace(/œ/g, "oe").replace(/'/g, "' ");
            var lettres_accentuees = "àäâéèêëîïôöùüûÿ".split("");
            var lettres_normales = "aaaeeeeiioouuuy".split("");
            for(let i = 0; i < lettres_normales.length; i++){
                str = str.replace(new RegExp(lettres_accentuees[i], 'g'), lettres_normales[i]);
            }
            return str;
        }


        function are_similar(nom1, nom2){
            var exact_match = standardize(nom1)==standardize(nom2);
            var regex_rues = /\brue |\bavenue |\bboulevard |\bcours |\bplace |\bimpasse |\ballée |\bruelle |\bpassage |\bpont |\bmontée |\bquai |\btunnel |\bgrande rue |\bmontee |\ballee |\bbretelle |\bmail |\bcite |\banse |\bcarrefour |\bchaussee |\bchemin |\bclos |\bcote |\bcour |\bcours |\bdegre |\bdescente |\bdreve |\bescoussiere |\besplanade |\bgaffe |\bgrand route |\bliaison |\bplacette |\bpromenade |\bresidence |\brang |\brampe |\brond point |\broute |\bruelle |\bsente |\bsentier |\bsquare |\btraverse |\bvenelle |\bvoie |\bberge |\bdigue /g;
            var regex_stop_words = /\ble |\bla |\bl' |\bles |\bde |\bdu |\bdes |\bd' |\bun |\bune |\bl |\bd /g;
            var regex_military = /\bamiral |\bcaporal |\blieutenant |\bcapitaine |\bmajor |\bgénéral |\bgeneral |\bcolonel |\bmarechal |\blieutenant colonel |\bsergent |\bsergent chef |\badjudant |\bsous lieutenant |\bcommandant |\bpresident /g;
            var partial_match = standardize(nom1).replaceAll(regex_stop_words,"")==standardize(nom2).replaceAll(regex_rues,"").replaceAll(regex_stop_words,"").replaceAll(regex_military, "");
            return exact_match | partial_match;
            }


        function askNextStreet(){
            if (currentStreetIndex < Object.keys(names).length) {
                targetstreetName = names[currentStreetIndex];
                if(trouves_uniques.includes(targetstreetName)){
                    currentStreetIndex++;
                    askNextStreet();
                }
                print_score()
                document.getElementById("target_street").innerHTML = "<b>Rue à trouver </b>: "+targetstreetName
                alert("Rue à trouver : " + targetstreetName);
                attemptsLeft = 3;
                document.getElementById("remaining_attempts").innerHTML = attemptsLeft+" tentatives restantes"
                currentStreetIndex++;
            } else {
                alert("Bravo ! Vous avez trouvé toutes les rues !");
                print_score()
            }
        }

        function check_clicked_street(e){
            console.log(e.target);
            polyline = e.target
            name2 = polyline.nom
            if( are_similar(targetstreetName, name2) ){
                trouves[polylines.i]=true;
                color_roads(targetstreetName, "green");
                askNextStreet();
            }else{
                attemptsLeft -=1;
                document.getElementById("remaining_attempts").innerHTML = attemptsLeft+" tentatives restantes"
                if(attemptsLeft<0){
                    color_roads(targetstreetName, "red");
                    askNextStreet();
                }
            }
        }

        function color_roads(name, color){
            for(let i in polylines){
                    var name2 = names[i];
                    if(are_similar(name, name2)){
                        trouves[i] = true;
                        polylines[i].setStyle({"color":color});
                        polylines[i].bindTooltip(name2);   
                        if(polylines[i].wiki){
                            var [langue, page] = polylines[i].wiki.split(":");
                            polylines[i].bindPopup(
                                "<iframe style='height:400px;' src='https://" + langue + ".m.wikipedia.org/wiki/" + page + "'></iframe>"
                            );
                        }
                        find_length += polylines[i].length;
                        if (!trouves_uniques.includes(name2)){
                            add_in_list_found(name2, polylines[i]);
                        }
                    }
                }
        }

        function resetGame() {
            // Reset game logic here if needed
            location.reload();
        }

        function couleur_par_score(pts){
            if(pts < 0.5){
              return rgbToHex(
                  Math.floor(255),
                  Math.floor(255 * 2 * pts),
                  0);
            }else{
              return rgbToHex(
                  Math.floor(255 - 255 * pts / 2),
                  Math.floor(255),
                  0);
            }
        }

        function componentToHex(c) {
            let hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function hexToRgb(hex){
            var r = parseInt(hex.slice(1, 3), 16);
            var g = parseInt(hex.slice(3, 5), 16);
            var b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b];
        }

        function downloadObjectAsJson(exportObj, exportName){
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        document.getElementById("save").onclick = function(){
            downloadObjectAsJson(trouves, "streetfinder_save_" + lieu);
        }

        function upload_save(saved_trouvees){
            for(let i in polylines){
                var name2 = names[i];
                if(saved_trouvees[i]){
                    polylines[i].setStyle({"color":"green"});
                    polylines[i].bindTooltip(name2);
                    if(polylines[i].wiki){
                        var [langue, page] = polylines[i].wiki.split(":");
                        polylines[i].bindPopup(
                            "<iframe style='height:400px;' src='https://" + langue + ".m.wikipedia.org/wiki/" + page + "'></iframe>"
                        );
                    }
                    if (!trouves[i]){
                        find_length += polylines[i].length;
                        trouves[i] = true;
                    }
                    if (!trouves_uniques.includes(name2)){
                        add_in_list_found(name2, polylines[i]);
                    }
                }
            }
            print_score();
        }

        function add_in_list_found(name, thispolyline){
            var name_std = standardize(name).replace(/' /g, "_").replace(/ /g, "_");
            var li = document.createElement("li");
            li.innerHTML = "<li id='list_found_" + name_std + "'>" + name + "</li>";
            document.getElementById("list_found").appendChild(li);
            document.getElementById("list_found_" + name_std).onclick = function(){
                thispolyline.openTooltip();
                mymap.panTo(thispolyline._latlngs[0], thispolyline._latlngs[1]);
            }
            document.getElementById("list_found_" + name_std).scrollIntoView();
            trouves_uniques.push(name);
        }

        document.getElementById("upload").onchange = function(){
            var file = document.getElementById("upload").files[0];
            var urlfile = URL.createObjectURL(file);
            fetch(urlfile)
            .then(r => r.json())
            .then(r => upload_save(r));
        }
    </script>
</body>
</html>
